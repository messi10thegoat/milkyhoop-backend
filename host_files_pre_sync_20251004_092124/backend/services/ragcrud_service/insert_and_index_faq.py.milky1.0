import asyncio
import grpc
import os
from openai import OpenAI
from milkyhoop_protos import ragcrud_service_pb2 as crud_pb
from milkyhoop_protos import ragcrud_service_pb2_grpc as crud_pb_grpc
from milkyhoop_protos import ragindex_service_pb2 as index_pb
from milkyhoop_protos import ragindex_service_pb2_grpc as index_pb_grpc

# Init OpenAI client
openai_api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=openai_api_key)

# Fungsi generate embedding
async def generate_embedding(text: str) -> list:
    response = await asyncio.to_thread(
        client.embeddings.create,
        model="text-embedding-3-small",
        input=text
    )
    return response.data[0].embedding

# MilkyBot Onboarding Knowledge Content
onboarding_content = """ðŸ“˜ MilkyBot Onboarding Knowledge Base

Q: User mengeluh banyak chat customer yang repetitive tentang produk dan harga
A: Pasti capek ya jawab pertanyaan yang sama terus tentang produk dan harga? Gimana kalau kita bikin chatbot yang bisa jawab otomatis? Kamu tinggal upload katalog atau FAQ, terus chatbot-nya bisa dipasang di Instagram bio!

Q: User stress handle customer service manual sendirian
A: Kebayang deh stressnya handle customer service sendirian. Chatbot bisa bantu handle 80% pertanyaan customer otomatis, jadi kamu bisa fokus ke hal yang lebih penting. Mau coba setup?

Q: User takut teknologi terlalu ribet untuk dipelajari
A: Tenang! MilkyHoop dibuat khusus untuk yang gak ngerti teknologi. Prosesnya simple: ngobrol sama aku â†’ upload dokumen â†’ chatbot langsung jadi dengan URL milkyhoop.com/namabisniskamu

Q: User punya bisnis skincare atau kosmetik
A: Wah bisnis skincare! Pasti banyak yang tanya cara pakai, ingredient, jenis kulit yang cocok, harga ya? Chatbot bisa handle semua itu. Customer bisa langsung dapet info produk tanpa kamu harus standby 24/7.

Q: User punya bisnis F&B atau kuliner  
A: Bisnis kuliner! Pasti banyak yang tanya menu, harga, cara order, lokasi ya? Chatbot bisa handle semua itu. Customer bisa langsung liat menu dan pesan tanpa kamu harus standby 24/7.

Q: User punya sekolah atau institusi pendidikan
A: Guru dan admin pasti sering dihubungi soal jadwal, tugas, pengumuman kan? Chatbot bisa jawab semua pertanyaan siswa dan orang tua otomatis. Upload jadwal dan info sekolah, langsung jadi!

Q: User organize event atau wedding
A: Event organizer pasti capek jawab pertanyaan yang sama: lokasi, rundown, dress code, kontribusi. Chatbot bisa handle semua info event, tamu tinggal chat untuk dapet info lengkap!

Q: User siap upload dokumen untuk chatbot
A: Perfect! Upload aja FAQ, katalog produk, atau dokumen yang biasa kamu kirim ke customer. Nanti aku proses jadi chatbot yang bisa jawab otomatis!

Q: User sudah upload dokumen dan siap deploy chatbot
A: Chatbot kamu udah siap! Ini link-nya: milkyhoop.com/[namatenant]. Bisa langsung dipasang di Instagram bio, website, atau dibagikan ke customer!

Q: Bagaimana cara kerja MilkyHoop chatbot builder
A: Gampang banget! 1) Ceritain bisnis kamu ke MilkyBot, 2) Upload FAQ/katalog/dokumen, 3) Chatbot langsung jadi dan bisa dipasang dimana aja dengan URL unik kamu.

Q: Keunggulan MilkyHoop dibanding platform lain
A: MilkyHoop unik karena prosesnya conversational - kamu cuma ngobrol sama MilkyBot, gak perlu belajar interface rumit. Plus setiap user dapet URL personal dan AI-nya bisa reasoning, bukan cuma copy-paste jawaban.
"""

async def main():
    tenantId = "milkybot_onboarding"  # Dedicated tenant for MilkyBot knowledge
    
    # 1. Simpan ke ragcrud_service
    async with grpc.aio.insecure_channel("localhost:5001") as crud_channel:
        crud_stub = crud_pb_grpc.RagCrudServiceStub(crud_channel)
        create_request = crud_pb.CreateRagDocumentRequest(
            tenantId=tenantId,
            title="MilkyBot Onboarding Knowledge Base",
            content=onboarding_content
        )
        create_response = await crud_stub.CreateRagDocument(create_request)
        doc_id = create_response.id
        print(f"âœ… MilkyBot Knowledge injected: ID = {doc_id}")

    # 2. Generate embedding
    embedding = await generate_embedding(onboarding_content)
    print("âœ… Embedding dibuat")

    # 3. Kirim ke ragindex_service  
    async with grpc.aio.insecure_channel("ragindex_service:5006") as index_channel:
        index_stub = index_pb_grpc.RagIndexServiceStub(index_channel)
        index_request = index_pb.IndexDocumentRequest(
            doc_id=doc_id,
            embedding=embedding
        )
        await index_stub.IndexDocument(index_request)
        print("âœ… MilkyBot Knowledge terindex ke FAISS")

if __name__ == "__main__":
    asyncio.run(main())