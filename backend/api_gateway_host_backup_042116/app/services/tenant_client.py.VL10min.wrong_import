import grpc
from typing import Dict, Any, Optional
import asyncio

class TenantParserClient:
    def __init__(self):
        self.channel = None
        self.stub = None
        self.is_connected = False

    async def _ensure_connection(self):
        """Ensure gRPC connection is established"""
        if not self.is_connected:
            try:
                self.channel = grpc.aio.insecure_channel('tenant_parser:5012')
                
                # Import CORRECT proto files - IntentParserService!
                import sys
                import os
                sys.path.append('/app')
                
                # Use tenant_parser proto, not rag proto!
                try:
                    # Try protos structure first
                    from protos.intent_parser import intent_parser_pb2_grpc, intent_parser_pb2
                    print("âœ… Using protos.intent_parser")
                except ImportError:
                    # Try local app structure
                    from backend.services.tenant_parser.app import tenant_parser_pb2_grpc as intent_parser_pb2_grpc
                    from backend.services.tenant_parser.app import tenant_parser_pb2 as intent_parser_pb2
                    print("âœ… Using local tenant_parser proto")
                
                self.stub = intent_parser_pb2_grpc.IntentParserServiceStub(self.channel)
                self.intent_parser_pb2 = intent_parser_pb2
                self.is_connected = True
                print("âœ… Tenant parser client connected successfully")
                
            except Exception as e:
                print(f"âŒ Tenant parser client failed: {e}")
                import traceback
                traceback.print_exc()
                self.is_connected = False
                raise

    async def parse_customer_query(self, tenant_id: str, message: str, session_id: str = "default") -> Dict[str, Any]:
        """
        FIXED: Use correct IntentParserService.DoSomething method
        """
        try:
            print(f"ğŸš€ Intent Parser Request: tenant={tenant_id}, message={message[:50]}...")
            
            # Ensure connection
            await self._ensure_connection()
            
            # Create request with IntentParserRequest format
            # Need to check what fields IntentParserRequest actually has
            request = self.intent_parser_pb2.IntentParserRequest(
                user_id=tenant_id,     # Pass tenant as user_id
                message=message,       # Pass message
                session_id=session_id  # Pass session_id if field exists
            )
            
            print(f"ğŸ¯ Calling DoSomething: user_id={tenant_id}, message={message[:30]}...")
            
            # Call correct method: DoSomething
            response = await self.stub.DoSomething(request)
            
            print(f"ğŸ“¥ RAW Response: {response.response[:100]}...")
            
            # Return structured response
            result = {
                "response": response.response,
                "confidence": getattr(response, 'confidence', 0.8),
                "metadata": {
                    "service": "tenant_parser",
                    "tenant_id": tenant_id,
                    "source": "intent_parser_service",
                    "method": "DoSomething"
                }
            }
            
            print(f"âœ… SUCCESS PATH: Got response length {len(response.response)}")
            return result
            
        except grpc.aio.AioRpcError as e:
            print(f"âŒ gRPC error: {e.code()} - {e.details()}")
            
            # Generic fallback
            return {
                "response": f"Maaf, saya sedang mengalami kendala teknis untuk mengakses informasi {tenant_id}. Tim teknis sedang memperbaiki sistem.",
                "confidence": 0.3,
                "metadata": {
                    "service": "fallback",
                    "error": f"gRPC {e.code()}: {e.details()}",
                    "issue": "intent_parser_service_error"
                }
            }
        except Exception as e:
            print(f"âŒ Tenant parser error: {e}")
            import traceback
            traceback.print_exc()
            
            # Generic fallback
            return {
                "response": f"Maaf, saya sedang mengalami kendala teknis untuk mengakses informasi {tenant_id}. Silakan coba lagi atau tanyakan hal lain.",
                "confidence": 0.3,
                "metadata": {
                    "service": "fallback",
                    "error": str(e)
                }
            }

# Global instance
tenant_client = TenantParserClient()
