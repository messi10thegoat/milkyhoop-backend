import os
import sys
import asyncio
from typing import AsyncGenerator
from contextlib import asynccontextmanager

import structlog
from fastapi import FastAPI

from .routers import health
from .routers import chat
# from .routers import auth  # DISABLED: auth service removed
from .routers import customer
from backend.api_gateway.app.routers import ragcrud_test
from backend.api_gateway.app.routers import ragllm_test
from backend.api_gateway.app.routers import raginject_test
from backend.api_gateway.app.routers import flow
from backend.api_gateway.app.routers import onboarding

# Phase 2.2 - Test context router
from backend.api_gateway.app.routers import test_context

# Phase 2.3 - Session management router
from backend.api_gateway.app.routers import session
from backend.api_gateway.app.routers import token_refresh

# Import auth middleware with session management
from .middleware.auth_middleware import AuthMiddleware

# âœ… Logging setup
structlog.configure(
    processors=[
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.dev.ConsoleRenderer(),
    ],
    logger_factory=structlog.PrintLoggerFactory(file=sys.stdout)
)

# âœ… Prisma binary path
os.environ["PRISMA_QUERY_ENGINE_BINARY"] = "/app/libs/milkyhoop_prisma/engine/query-engine-debian-openssl-3.0.x"

# â›“ï¸ Prisma client (Python)
from backend.api_gateway.libs.milkyhoop_prisma import Prisma

prisma = Prisma()

# ðŸ” Prisma lifecycle (startup & shutdown)
@asynccontextmanager
async def prisma_lifespan(app: FastAPI) -> AsyncGenerator[None, None]:
    retries = 5
    for attempt in range(1, retries + 1):
        try:
            await prisma.connect()
            print("âœ… Prisma connected.")
            break
        except Exception as e:
            print(f"âš ï¸ Retry {attempt}/{retries} connecting Prisma failed: {e}")
            await asyncio.sleep(3)
    else:
        raise RuntimeError("âŒ Prisma failed to connect after retries.")

    yield

    await prisma.disconnect()
    print("ðŸ›‘ Prisma disconnected.")

# ðŸš€ FastAPI instance
app = FastAPI(
    title="MilkyHoop API Gateway",
    version="3.0.0",
    lifespan=prisma_lifespan,
    redirect_slashes=False,
    description="Enterprise API Gateway with Authentication & Session Management"
)

# ðŸ” Add Authentication Middleware with Session Management (AFTER app creation, BEFORE routers)
app.add_middleware(AuthMiddleware)

# ðŸ§© Register all routers (aktifkan yang sudah ada)
app.include_router(health.router, tags=["Health"])
app.include_router(chat.router, tags=["Chat"])   # â¬…ï¸ Pastikan baris ini ada!
app.include_router(customer.router, prefix="/tenant", tags=["Customer"])
app.include_router(ragcrud_test.router, prefix="/ragcrud", tags=["RAG CRUD"])
app.include_router(ragllm_test.router, tags=["RAG LLM"])
app.include_router(raginject_test.router, tags=["RAG Inject"])
app.include_router(flow.router, tags=["Flow"])
app.include_router(onboarding.router, prefix="/onboarding", tags=["Onboarding"])

# Phase 2.2 & 2.3 - Authentication & Session Management routers
app.include_router(test_context.router, prefix="/api", tags=["Test Context"])
app.include_router(session.router, prefix="/api", tags=["Session Management"])
app.include_router(token_refresh.router, prefix="/api", tags=["Token Refresh"])

# app.include_router(auth.router, prefix="/auth", tags=["Authentication"])  # DISABLED: auth service removed

# ðŸ“¡ Root endpoint
@app.get("/", tags=["Root"])
def root() -> dict:
    return {
        "message": "Welcome to MilkyHoop API Gateway", 
        "version": "3.0.0",
        "authentication": "enabled",
        "session_management": "enabled",
        "features": [
            "JWT Authentication",
            "Redis Session Storage", 
            "Token Refresh",
            "Cross-device Session Management",
            "Graceful Logout"
        ]
    }