{"ast":null,"code":"export const getToken=()=>{return localStorage.getItem('access_token');};export const getRefreshToken=()=>{return localStorage.getItem('refresh_token');};export const setTokens=(accessToken,refreshToken)=>{localStorage.setItem('access_token',accessToken);localStorage.setItem('refresh_token',refreshToken);localStorage.setItem('token_timestamp',Date.now().toString());};export const isTokenExpiringSoon=()=>{const token=getToken();if(!token)return true;try{const payload=JSON.parse(atob(token.split('.')[1]));const expiryTime=payload.exp*1000;const now=Date.now();const fiveMinutes=5*60*1000;return expiryTime-now<fiveMinutes;}catch(_unused){return true;}};/**\n * Refresh access token with retry mechanism (industry standard like Claude/ChatGPT)\n * Retries network errors, only logout on explicit token rejection (401)\n */export const refreshAccessToken=async function(){let retryCount=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;const MAX_RETRIES=3;const RETRY_DELAYS=[1000,2000,4000];// Exponential backoff: 1s, 2s, 4s\nconst refreshToken=getRefreshToken();if(!refreshToken){logout('no_refresh_token');return false;}try{const response=await fetch('/api/auth/refresh',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({refresh_token:refreshToken})});// Explicit token rejection (invalid, expired, revoked)\nif(response.status===401||response.status===403){console.error('[refreshAccessToken] Token invalid/expired, logging out');logout('token_expired');return false;}// Server error or network issue - retry\nif(!response.ok){if(retryCount<MAX_RETRIES){const delay=RETRY_DELAYS[retryCount];console.warn(\"[refreshAccessToken] Server error (\".concat(response.status,\"), retrying in \").concat(delay,\"ms... (\").concat(retryCount+1,\"/\").concat(MAX_RETRIES,\")\"));await new Promise(resolve=>setTimeout(resolve,delay));return refreshAccessToken(retryCount+1);}else{console.error('[refreshAccessToken] Max retries reached, logging out');logout('refresh_failed');return false;}}const data=await response.json();if(data.success&&data.data.access_token){setTokens(data.data.access_token,data.data.refresh_token);console.log('[refreshAccessToken] Token refreshed successfully');return true;}// Unexpected response format\nconsole.error('[refreshAccessToken] Unexpected response format');logout('refresh_failed');return false;}catch(error){// Network error (offline, timeout, etc) - retry\nif(retryCount<MAX_RETRIES){const delay=RETRY_DELAYS[retryCount];console.warn(\"[refreshAccessToken] Network error, retrying in \".concat(delay,\"ms... (\").concat(retryCount+1,\"/\").concat(MAX_RETRIES,\")\"),error);await new Promise(resolve=>setTimeout(resolve,delay));return refreshAccessToken(retryCount+1);}else{console.error('[refreshAccessToken] Max retries reached after network errors, logging out');logout('network_error');return false;}}};export const getUserEmail=()=>{const token=getToken();if(!token)return null;try{const payload=JSON.parse(atob(token.split('.')[1]));return payload.email||null;}catch(_unused2){return null;}};export const isAuthenticated=()=>{return!!getToken();};/**\n * Logout with reason tracking\n * @param reason - Why logout occurred: 'manual', 'token_expired', 'refresh_failed', 'network_error', 'no_refresh_token'\n */export const logout=async function(){let reason=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'manual';const refreshToken=getRefreshToken();const token=getToken();// Call backend logout endpoint (only for manual logout with valid tokens)\nif(refreshToken&&token&&reason==='manual'){try{const payload=JSON.parse(atob(token.split('.')[1]));const userId=payload.user_id;await fetch(\"/api/auth/logout?user_id=\".concat(userId),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({refresh_token:refreshToken,logout_all_devices:false})});}catch(error){console.error('[logout] Backend logout API call failed:',error);}}// Clear local storage\nlocalStorage.removeItem('access_token');localStorage.removeItem('refresh_token');localStorage.removeItem('token_timestamp');// Dispatch logout event with reason for UI components to react\nwindow.dispatchEvent(new CustomEvent('logout',{detail:{reason}}));console.log(\"[logout] User logged out, reason: \".concat(reason));};","map":{"version":3,"names":["getToken","localStorage","getItem","getRefreshToken","setTokens","accessToken","refreshToken","setItem","Date","now","toString","isTokenExpiringSoon","token","payload","JSON","parse","atob","split","expiryTime","exp","fiveMinutes","_unused","refreshAccessToken","retryCount","arguments","length","undefined","MAX_RETRIES","RETRY_DELAYS","logout","response","fetch","method","headers","body","stringify","refresh_token","status","console","error","ok","delay","warn","concat","Promise","resolve","setTimeout","data","json","success","access_token","log","getUserEmail","email","_unused2","isAuthenticated","reason","userId","user_id","logout_all_devices","removeItem","window","dispatchEvent","CustomEvent","detail"],"sources":["/root/milkyhoop-dev/frontend/web/src/utils/auth.ts"],"sourcesContent":["export const getToken = (): string | null => {\n  return localStorage.getItem('access_token');\n};\n\nexport const getRefreshToken = (): string | null => {\n  return localStorage.getItem('refresh_token');\n};\n\nexport const setTokens = (accessToken: string, refreshToken: string): void => {\n  localStorage.setItem('access_token', accessToken);\n  localStorage.setItem('refresh_token', refreshToken);\n  localStorage.setItem('token_timestamp', Date.now().toString());\n};\n\nexport const isTokenExpiringSoon = (): boolean => {\n  const token = getToken();\n  if (!token) return true;\n  \n  try {\n    const payload = JSON.parse(atob(token.split('.')[1]));\n    const expiryTime = payload.exp * 1000;\n    const now = Date.now();\n    const fiveMinutes = 5 * 60 * 1000;\n    \n    return (expiryTime - now) < fiveMinutes;\n  } catch {\n    return true;\n  }\n};\n\n/**\n * Refresh access token with retry mechanism (industry standard like Claude/ChatGPT)\n * Retries network errors, only logout on explicit token rejection (401)\n */\nexport const refreshAccessToken = async (retryCount = 0): Promise<boolean> => {\n  const MAX_RETRIES = 3;\n  const RETRY_DELAYS = [1000, 2000, 4000]; // Exponential backoff: 1s, 2s, 4s\n  \n  const refreshToken = getRefreshToken();\n  if (!refreshToken) {\n    logout('no_refresh_token');\n    return false;\n  }\n  \n  try {\n    const response = await fetch('/api/auth/refresh', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ refresh_token: refreshToken })\n    });\n    \n    // Explicit token rejection (invalid, expired, revoked)\n    if (response.status === 401 || response.status === 403) {\n      console.error('[refreshAccessToken] Token invalid/expired, logging out');\n      logout('token_expired');\n      return false;\n    }\n    \n    // Server error or network issue - retry\n    if (!response.ok) {\n      if (retryCount < MAX_RETRIES) {\n        const delay = RETRY_DELAYS[retryCount];\n        console.warn(`[refreshAccessToken] Server error (${response.status}), retrying in ${delay}ms... (${retryCount + 1}/${MAX_RETRIES})`);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        return refreshAccessToken(retryCount + 1);\n      } else {\n        console.error('[refreshAccessToken] Max retries reached, logging out');\n        logout('refresh_failed');\n        return false;\n      }\n    }\n    \n    const data = await response.json();\n    if (data.success && data.data.access_token) {\n      setTokens(data.data.access_token, data.data.refresh_token);\n      console.log('[refreshAccessToken] Token refreshed successfully');\n      return true;\n    }\n    \n    // Unexpected response format\n    console.error('[refreshAccessToken] Unexpected response format');\n    logout('refresh_failed');\n    return false;\n    \n  } catch (error) {\n    // Network error (offline, timeout, etc) - retry\n    if (retryCount < MAX_RETRIES) {\n      const delay = RETRY_DELAYS[retryCount];\n      console.warn(`[refreshAccessToken] Network error, retrying in ${delay}ms... (${retryCount + 1}/${MAX_RETRIES})`, error);\n      await new Promise(resolve => setTimeout(resolve, delay));\n      return refreshAccessToken(retryCount + 1);\n    } else {\n      console.error('[refreshAccessToken] Max retries reached after network errors, logging out');\n      logout('network_error');\n      return false;\n    }\n  }\n};\n\nexport const getUserEmail = (): string | null => {\n  const token = getToken();\n  if (!token) return null;\n  \n  try {\n    const payload = JSON.parse(atob(token.split('.')[1]));\n    return payload.email || null;\n  } catch {\n    return null;\n  }\n};\n\nexport const isAuthenticated = (): boolean => {\n  return !!getToken();\n};\n\n/**\n * Logout with reason tracking\n * @param reason - Why logout occurred: 'manual', 'token_expired', 'refresh_failed', 'network_error', 'no_refresh_token'\n */\nexport const logout = async (reason: string = 'manual') => {\n  const refreshToken = getRefreshToken();\n  const token = getToken();\n  \n  // Call backend logout endpoint (only for manual logout with valid tokens)\n  if (refreshToken && token && reason === 'manual') {\n    try {\n      const payload = JSON.parse(atob(token.split('.')[1]));\n      const userId = payload.user_id;\n      \n      await fetch(`/api/auth/logout?user_id=${userId}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          refresh_token: refreshToken,\n          logout_all_devices: false\n        })\n      });\n    } catch (error) {\n      console.error('[logout] Backend logout API call failed:', error);\n    }\n  }\n  \n  // Clear local storage\n  localStorage.removeItem('access_token');\n  localStorage.removeItem('refresh_token');\n  localStorage.removeItem('token_timestamp');\n  \n  // Dispatch logout event with reason for UI components to react\n  window.dispatchEvent(new CustomEvent('logout', { detail: { reason } }));\n  \n  console.log(`[logout] User logged out, reason: ${reason}`);\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}