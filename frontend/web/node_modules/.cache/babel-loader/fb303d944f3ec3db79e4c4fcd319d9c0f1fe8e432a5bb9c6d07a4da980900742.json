{"ast":null,"code":"/**\n * WebSocket Client for QR Login System\n * Handles real-time QR status updates and device force logout\n *//**\n * QR Login WebSocket Client\n * Used by desktop browser to receive real-time status updates\n */export class QRWebSocketClient{constructor(token,onEvent){this.ws=null;this.token=void 0;this.onEvent=void 0;this.reconnectAttempts=0;this.maxReconnectAttempts=3;this.pingInterval=null;this.token=token;this.onEvent=onEvent;}connect(){const protocol=window.location.protocol==='https:'?'wss:':'ws:';const wsUrl=\"\".concat(protocol,\"//\").concat(window.location.host,\"/api/auth/qr/ws/\").concat(this.token);console.log('[QRWebSocket] Connecting to:',wsUrl);this.ws=new WebSocket(wsUrl);this.ws.onopen=()=>{console.log('[QRWebSocket] Connected');this.reconnectAttempts=0;this.startPing();};this.ws.onmessage=event=>{try{const data=JSON.parse(event.data);console.log('[QRWebSocket] Event received:',data.event);this.onEvent(data);// Handle terminal events\nif(data.event==='approved'||data.event==='rejected'||data.event==='expired'){this.disconnect();}}catch(e){console.error('[QRWebSocket] Failed to parse message:',e);}};this.ws.onerror=error=>{console.error('[QRWebSocket] Error:',error);this.onEvent({event:'error',message:'WebSocket connection error'});};this.ws.onclose=event=>{console.log('[QRWebSocket] Closed:',event.code,event.reason);this.stopPing();// Attempt reconnect if not intentional disconnect\nif(event.code!==1000&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;console.log(\"[QRWebSocket] Reconnecting... attempt \".concat(this.reconnectAttempts));setTimeout(()=>this.connect(),2000);}};}startPing(){this.pingInterval=setInterval(()=>{var _this$ws;if(((_this$ws=this.ws)===null||_this$ws===void 0?void 0:_this$ws.readyState)===WebSocket.OPEN){this.ws.send(JSON.stringify({event:'ping'}));}},30000);// Ping every 30 seconds\n}stopPing(){if(this.pingInterval){clearInterval(this.pingInterval);this.pingInterval=null;}}disconnect(){this.stopPing();if(this.ws){this.ws.close(1000,'Client disconnect');this.ws=null;}}isConnected(){var _this$ws2;return((_this$ws2=this.ws)===null||_this$ws2===void 0?void 0:_this$ws2.readyState)===WebSocket.OPEN;}}/**\n * Device WebSocket Client\n * Used by web sessions to receive force logout commands\n */export class DeviceWebSocketClient{constructor(deviceId,onEvent){this.ws=null;this.deviceId=void 0;this.onEvent=void 0;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.pingInterval=null;this.deviceId=deviceId;this.onEvent=onEvent;}connect(){const protocol=window.location.protocol==='https:'?'wss:':'ws:';const wsUrl=\"\".concat(protocol,\"//\").concat(window.location.host,\"/api/devices/ws/\").concat(this.deviceId);console.log('[DeviceWebSocket] Connecting to:',wsUrl);this.ws=new WebSocket(wsUrl);this.ws.onopen=()=>{console.log('[DeviceWebSocket] Connected');this.reconnectAttempts=0;this.startPing();};this.ws.onmessage=event=>{try{const data=JSON.parse(event.data);console.log('[DeviceWebSocket] Event received:',data.event);this.onEvent(data);// Handle force logout\nif(data.event==='force_logout'){this.disconnect();}}catch(e){console.error('[DeviceWebSocket] Failed to parse message:',e);}};this.ws.onerror=error=>{console.error('[DeviceWebSocket] Error:',error);};this.ws.onclose=event=>{console.log('[DeviceWebSocket] Closed:',event.code,event.reason);this.stopPing();// Attempt reconnect\nif(event.code!==1000&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;setTimeout(()=>this.connect(),3000*this.reconnectAttempts);}};}startPing(){this.pingInterval=setInterval(()=>{var _this$ws3;if(((_this$ws3=this.ws)===null||_this$ws3===void 0?void 0:_this$ws3.readyState)===WebSocket.OPEN){this.ws.send(JSON.stringify({event:'ping'}));}},30000);}stopPing(){if(this.pingInterval){clearInterval(this.pingInterval);this.pingInterval=null;}}disconnect(){this.stopPing();if(this.ws){this.ws.close(1000,'Client disconnect');this.ws=null;}}}","map":{"version":3,"names":["QRWebSocketClient","constructor","token","onEvent","ws","reconnectAttempts","maxReconnectAttempts","pingInterval","connect","protocol","window","location","wsUrl","concat","host","console","log","WebSocket","onopen","startPing","onmessage","event","data","JSON","parse","disconnect","e","error","onerror","message","onclose","code","reason","stopPing","setTimeout","setInterval","_this$ws","readyState","OPEN","send","stringify","clearInterval","close","isConnected","_this$ws2","DeviceWebSocketClient","deviceId","_this$ws3"],"sources":["/root/milkyhoop-dev/frontend/web/src/utils/websocket.ts"],"sourcesContent":["/**\n * WebSocket Client for QR Login System\n * Handles real-time QR status updates and device force logout\n */\n\nexport type QREvent =\n  | { event: 'connected'; message: string }\n  | { event: 'scanned'; message: string }\n  | { event: 'approved'; message: string; access_token: string; refresh_token: string; user: any }\n  | { event: 'rejected'; message: string }\n  | { event: 'expired'; message: string }\n  | { event: 'ping' }\n  | { event: 'pong' }\n  | { event: 'error'; message: string };\n\nexport type DeviceEvent =\n  | { event: 'force_logout'; reason: string }\n  | { event: 'ping' }\n  | { event: 'pong' };\n\ntype QREventHandler = (event: QREvent) => void;\ntype DeviceEventHandler = (event: DeviceEvent) => void;\n\n/**\n * QR Login WebSocket Client\n * Used by desktop browser to receive real-time status updates\n */\nexport class QRWebSocketClient {\n  private ws: WebSocket | null = null;\n  private token: string;\n  private onEvent: QREventHandler;\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 3;\n  private pingInterval: NodeJS.Timeout | null = null;\n\n  constructor(token: string, onEvent: QREventHandler) {\n    this.token = token;\n    this.onEvent = onEvent;\n  }\n\n  connect(): void {\n    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n    const wsUrl = `${protocol}//${window.location.host}/api/auth/qr/ws/${this.token}`;\n\n    console.log('[QRWebSocket] Connecting to:', wsUrl);\n\n    this.ws = new WebSocket(wsUrl);\n\n    this.ws.onopen = () => {\n      console.log('[QRWebSocket] Connected');\n      this.reconnectAttempts = 0;\n      this.startPing();\n    };\n\n    this.ws.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data) as QREvent;\n        console.log('[QRWebSocket] Event received:', data.event);\n        this.onEvent(data);\n\n        // Handle terminal events\n        if (data.event === 'approved' || data.event === 'rejected' || data.event === 'expired') {\n          this.disconnect();\n        }\n      } catch (e) {\n        console.error('[QRWebSocket] Failed to parse message:', e);\n      }\n    };\n\n    this.ws.onerror = (error) => {\n      console.error('[QRWebSocket] Error:', error);\n      this.onEvent({ event: 'error', message: 'WebSocket connection error' });\n    };\n\n    this.ws.onclose = (event) => {\n      console.log('[QRWebSocket] Closed:', event.code, event.reason);\n      this.stopPing();\n\n      // Attempt reconnect if not intentional disconnect\n      if (event.code !== 1000 && this.reconnectAttempts < this.maxReconnectAttempts) {\n        this.reconnectAttempts++;\n        console.log(`[QRWebSocket] Reconnecting... attempt ${this.reconnectAttempts}`);\n        setTimeout(() => this.connect(), 2000);\n      }\n    };\n  }\n\n  private startPing(): void {\n    this.pingInterval = setInterval(() => {\n      if (this.ws?.readyState === WebSocket.OPEN) {\n        this.ws.send(JSON.stringify({ event: 'ping' }));\n      }\n    }, 30000); // Ping every 30 seconds\n  }\n\n  private stopPing(): void {\n    if (this.pingInterval) {\n      clearInterval(this.pingInterval);\n      this.pingInterval = null;\n    }\n  }\n\n  disconnect(): void {\n    this.stopPing();\n    if (this.ws) {\n      this.ws.close(1000, 'Client disconnect');\n      this.ws = null;\n    }\n  }\n\n  isConnected(): boolean {\n    return this.ws?.readyState === WebSocket.OPEN;\n  }\n}\n\n/**\n * Device WebSocket Client\n * Used by web sessions to receive force logout commands\n */\nexport class DeviceWebSocketClient {\n  private ws: WebSocket | null = null;\n  private deviceId: string;\n  private onEvent: DeviceEventHandler;\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 5;\n  private pingInterval: NodeJS.Timeout | null = null;\n\n  constructor(deviceId: string, onEvent: DeviceEventHandler) {\n    this.deviceId = deviceId;\n    this.onEvent = onEvent;\n  }\n\n  connect(): void {\n    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n    const wsUrl = `${protocol}//${window.location.host}/api/devices/ws/${this.deviceId}`;\n\n    console.log('[DeviceWebSocket] Connecting to:', wsUrl);\n\n    this.ws = new WebSocket(wsUrl);\n\n    this.ws.onopen = () => {\n      console.log('[DeviceWebSocket] Connected');\n      this.reconnectAttempts = 0;\n      this.startPing();\n    };\n\n    this.ws.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data) as DeviceEvent;\n        console.log('[DeviceWebSocket] Event received:', data.event);\n        this.onEvent(data);\n\n        // Handle force logout\n        if (data.event === 'force_logout') {\n          this.disconnect();\n        }\n      } catch (e) {\n        console.error('[DeviceWebSocket] Failed to parse message:', e);\n      }\n    };\n\n    this.ws.onerror = (error) => {\n      console.error('[DeviceWebSocket] Error:', error);\n    };\n\n    this.ws.onclose = (event) => {\n      console.log('[DeviceWebSocket] Closed:', event.code, event.reason);\n      this.stopPing();\n\n      // Attempt reconnect\n      if (event.code !== 1000 && this.reconnectAttempts < this.maxReconnectAttempts) {\n        this.reconnectAttempts++;\n        setTimeout(() => this.connect(), 3000 * this.reconnectAttempts);\n      }\n    };\n  }\n\n  private startPing(): void {\n    this.pingInterval = setInterval(() => {\n      if (this.ws?.readyState === WebSocket.OPEN) {\n        this.ws.send(JSON.stringify({ event: 'ping' }));\n      }\n    }, 30000);\n  }\n\n  private stopPing(): void {\n    if (this.pingInterval) {\n      clearInterval(this.pingInterval);\n      this.pingInterval = null;\n    }\n  }\n\n  disconnect(): void {\n    this.stopPing();\n    if (this.ws) {\n      this.ws.close(1000, 'Client disconnect');\n      this.ws = null;\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
