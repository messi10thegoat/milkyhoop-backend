version: "3.8"

services:
  # Core Infrastructure
  postgres:
    image: postgres:14
    restart: always
    environment:
      POSTGRES_USER: milkyadmin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: milkydb
    ports:
      - "5433:5432"
    networks:
      - internal
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./logs/postgres:/var/log/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U milkyadmin"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:latest
    command: redis-server --requirepass MilkyRedis2025Secure
    restart: always
    ports:
      - "6380:6379"
    networks:
      - internal
    volumes:
      - redis_data:/data
      - ./logs/redis:/var/log/redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.2
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "7181:2181"
    networks:
      - internal
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  kafka:
    image: confluentinc/cp-kafka:7.3.2
    depends_on:
      - zookeeper
    ports:
      - "7092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - internal
    restart: always
    healthcheck:
      test: ["CMD", "kafka-topics", "--list", "--bootstrap-server", "localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 8-Service Core Production Stack
  api_gateway:
    build:
      context: .
      dockerfile: backend/api_gateway/Dockerfile
    ports:
      - "8001:8000"
    networks:
      - internal
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CHATBOT_GRPC_HOST=chatbot_service
      - RAG_GRPC_HOST=ragcrud_service
      - RAGCRUD_GRPC_HOST=ragcrud_service
      - RAGLLM_GRPC_HOST=ragllm_service
      - INTENT_PARSER_GRPC_HOST=intent_parser
      - FLOW_EXECUTOR_HOST=http://flow-executor:8088
      - JWT_SECRET=bb599073be39674d540ba07d77967282d4fa26247f6d17d8a60b093002d70d40
    env_file:
      - .env
    volumes:
      - ./backend/api_gateway:/app/backend/api_gateway
      - ./logs/api_gateway:/var/log
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - chatbot_service
      - ragcrud_service
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  chatbot_service:
    build:
      context: .
      dockerfile: backend/services/chatbot_service/Dockerfile
    ports:
      - "7003:5002"
    networks:
      - internal
    environment:
      - GRPC_PORT=5002
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    env_file:
      - .env
    volumes:
      - ./backend/api_gateway:/app/backend/api_gateway
      - ./logs/chatbot_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5002"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  intent_parser:
    build:
      context: .
      dockerfile: backend/services/intent_parser/Dockerfile
    ports:
      - "7009:5009"
    networks:
      - internal
    environment:
      - GRPC_PORT=5009
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    env_file:
      - .env
    volumes:
      - ./logs/intent_parser:/var/log
      - ./backend/services/intent_parser/app:/app/backend/services/intent_parser/app
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5009"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  tenant_parser:
    build:
      context: .
      dockerfile: backend/services/tenant_parser/Dockerfile
    ports:
      - "7012:5012"
    networks:
      - internal
    environment:
      - GRPC_PORT=5012
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - RAGCRUD_GRPC_HOST=ragcrud_service
      - RAGCRUD_GRPC_PORT=5001
      - RAGINDEX_GRPC_HOST=ragindex_service
      - RAGINDEX_GRPC_PORT=5006
      - RAGLLM_GRPC_HOST=ragllm_service
      - RAGLLM_GRPC_PORT=5000
    env_file:
      - .env
    volumes:
      - ./backend/services/tenant_parser/app:/app/backend/services/tenant_parser/app
      - ./backend/services/tenant_parser/libs:/app/backend/services/tenant_parser/libs
      - ./logs/tenant_parser:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5012"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  flow-executor:
    build:
      context: .
      dockerfile: ./backend/services/flow-executor/Dockerfile
    ports:
      - "7088:8088"
    networks:
      - internal
    environment:
      - LOG_LEVEL=debug
      - RAGLLM_GRPC_HOST=ragllm_service
      - RAGLLM_GRPC_PORT=5000
      - RAGCRUD_GRPC_HOST=ragcrud_service
      - RAGCRUD_GRPC_PORT=5001
      - KAFKA_BROKER=kafka:9092
    env_file:
      - .env
    volumes:
      - ./logs/flow-executor:/var/log
      - ./flows:/flows
    restart: always
    depends_on:
      - kafka
      - ragcrud_service
      - ragllm_service
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ragcrud_service:
    build:
      context: .
      dockerfile: backend/services/ragcrud_service/Dockerfile
    ports:
      - "7001:5001"
    networks:
      - internal
    environment:
      - GRPC_PORT=5001
      - DATABASE_URL=${DATABASE_URL}
      - PRISMA_QUERY_ENGINE_BINARY=/app/prisma-query-engine-debian-openssl-3.0.x
    env_file:
      - .env
    volumes:
      - ./logs/ragcrud_service:/var/log
      - ./backend/services/ragcrud_service:/app/backend/services/ragcrud_service
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5001"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ragindex_service:
    build:
      context: .
      dockerfile: backend/services/ragindex_service/Dockerfile
    ports:
      - "7006:5006"
    networks:
      - internal
    environment:
      - GRPC_PORT=5006
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    volumes:
      - ./logs/ragindex_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5006"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ragllm_service:
    build:
      context: .
      dockerfile: backend/services/ragllm_service/Dockerfile
    ports:
      - "7011:5000"
    networks:
      - internal
    environment:
      - GRPC_PORT=5000
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    volumes:
      - ./logs/ragllm_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5000"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  notification_service:
    build:
      context: ./backend/services/notification-service
    ports:
      - "7005:5005"
      - "7082:8080"
    networks:
      - internal
    env_file:
      - backend/services/notification-service/.env
    volumes:
      - ./logs/notification_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5005"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - kafka
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  memory_service:
    build:
      context: .
      dockerfile: backend/services/memory_service/Dockerfile
    ports:
      - "7000:5000"
    networks:
      - internal
    environment:
      - GRPC_PORT=5000
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
    env_file:
      - .env
    volumes:
      - ./logs/memory_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5000"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  conversation_service:
    build:
      context: .
      dockerfile: backend/services/conversation_service/Dockerfile
    container_name: milkyhoop-dev-conversation_service-1
    ports:
      - "7002:5002"
    networks:
      - internal
    environment:
      - GRPC_PORT=5002
      - SERVICE_NAME=ConversationService
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
    env_file:
      - .env
    volumes:
      - ./backend/services/conversation_service:/app/backend/services/conversation_service
      - ./protos:/app/protos
      - ./logs/conversation_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5002"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  context_service:
    build:
      context: .
      dockerfile: backend/services/context_service/Dockerfile
    ports:
      - "7007:5007"
    networks:
      - internal
    environment:
      - GRPC_PORT=5007
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
    env_file:
      - .env
    volumes:
      - ./logs/context_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5007"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cust_context:
    build:
      context: .
      dockerfile: backend/services/cust_context/Dockerfile
    ports:
      - "7080:8080"  # HTTP metrics server
      - "7008:5008"
    networks:
      - internal
    environment:
      - GRPC_PORT=5008
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      - PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
    env_file:
      - .env
    volumes:
      - ./logs/cust_context:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5008"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cust_orchestrator:
    build:
      context: .
      dockerfile: backend/services/cust_orchestrator/Dockerfile
    ports:
      - "7081:8080"  # HTTP metrics server
      - "7013:5013"
    networks:
      - internal
    environment:
      - GRPC_PORT=5013
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
      - CONTEXT_SERVICE_HOST=cust_context
      - CONTEXT_SERVICE_PORT=5008
    env_file:
      - .env
    volumes:
      - ./logs/cust_orchestrator:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5013"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
      - cust_context
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"




  auth_service:
    build:
      context: .
      dockerfile: backend/services/auth_service/Dockerfile
    ports:
      - "8014:8013"  # ← CHANGE 1: dari 7004:5004
    networks:
      - internal
    environment:
      - SERVICE_PORT=8013  # ← CHANGE 2: dari GRPC_PORT=5004
      - HTTP_PORT=8000
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=fe9e6b579ad0d194aea51b325e6f0790ace8b2bd3d91c059a016abd2c0e54de2  # ← CHANGE 3: new secret
      - REDIS_URL=redis://redis:6379
    env_file:
      - .env
    volumes:
      - ./logs/auth_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:8013"]  # ← CHANGE 4: dari 5004
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


  setup_orchestrator:
    build:
      context: .
      dockerfile: backend/services/setup_orchestrator/Dockerfile
    ports:
      - "7014:5014"  # gRPC port
    networks:
      - internal
    environment:
      - GRPC_PORT=5014
      - SERVICE_NAME=SetupOrchestrator
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=redis://redis:6379
      - INTENT_PARSER_GRPC_HOST=intent_parser
      - INTENT_PARSER_GRPC_PORT=5009
      - BUSINESS_EXTRACTOR_GRPC_HOST=business_extractor
      - BUSINESS_EXTRACTOR_GRPC_PORT=5015
      - CONVERSATION_MANAGER_GRPC_HOST=conversation_manager
      - CONVERSATION_MANAGER_GRPC_PORT=5016
      - RAGCRUD_GRPC_HOST=ragcrud_service
      - RAGCRUD_GRPC_PORT=5001
    env_file:
      - .env
    volumes:
      - ./backend/services/setup_orchestrator:/app/backend/services/setup_orchestrator
      - ./logs/setup_orchestrator:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5014"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
      - intent_parser
      - conversation_manager
      - business_extractor
      - ragcrud_service
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  conversation_manager:
    build:
      context: .
      dockerfile: backend/services/conversation_manager/Dockerfile
    ports:
      - "7016:5016"  # gRPC port
    networks:
      - internal
    environment:
      - GRPC_PORT=5016
      - SERVICE_NAME=ConversationManager
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis:6379
    env_file:
      - .env
    volumes:
      - ./backend/services/conversation_manager:/app/backend/services/conversation_manager
      - ./logs/conversation_manager:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5016"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  business_extractor:
    build:
      context: .
      dockerfile: backend/services/business_extractor/Dockerfile
    ports:
      - "7015:5015"  # gRPC port
    networks:
      - internal
    environment:
      - GRPC_PORT=5015
      - SERVICE_NAME=BusinessExtractor
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    volumes:
      - ./backend/services/business_extractor:/app/backend/services/business_extractor
      - ./logs/business_extractor:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5015"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  transaction_service:
    build:
      context: .
      dockerfile: backend/services/transaction_service/Dockerfile
    container_name: milkyhoop-dev-transaction_service-1
    ports:
      - "7020:7020"
    networks:
      - internal
    environment:
      - GRPC_PORT=7020
      - SERVICE_NAME=TransactionService
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    volumes:
      - ./backend/services/transaction_service:/app/backend/services/transaction_service
      - ./database/schemas:/app/database/schemas
      - ./protos:/app/protos
      - ./logs/transaction_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:7020"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


  reporting_service:
    build:
      context: .
      dockerfile: backend/services/reporting_service/Dockerfile
    container_name: milkyhoop-dev-reporting_service-1
    ports:
      - "7030:7030"
    networks:
      - internal
    environment:
      - GRPC_PORT=7030
      - SERVICE_NAME=ReportingService
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    volumes:
      - ./backend/services/reporting_service:/app/backend/services/reporting_service
      - ./database/schemas:/app/database/schemas
      - ./protos:/app/protos
      - ./logs/reporting_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:7030"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - transaction_service
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


  inventory_service:
    build:
      context: .
      dockerfile: backend/services/inventory_service/Dockerfile
    container_name: milkyhoop-dev-inventory_service-1
    ports:
      - "7040:7040"
    networks:
      - internal
    environment:
      - GRPC_PORT=7040
      - SERVICE_NAME=InventoryService
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    volumes:
      - ./backend/services/inventory_service:/app/backend/services/inventory_service
      - ./database/schemas:/app/database/schemas
      - ./protos:/app/protos
      - ./logs/inventory_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:7040"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - transaction_service
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


  accounting_service:
    build:
      context: .
      dockerfile: backend/services/accounting_service/Dockerfile
    container_name: milkyhoop-dev-accounting_service-1
    ports:
      - "7050:7050"
    networks:
      - internal
    environment:
      - GRPC_PORT=7050
      - SERVICE_NAME=AccountingService
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    volumes:
      - ./backend/services/accounting_service:/app/backend/services/accounting_service
      - ./database/schemas:/app/database/schemas
      - ./protos:/app/protos
      - ./logs/accounting_service:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:7050"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - transaction_service
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"




  tenant_orchestrator:
    build:
      context: .
      dockerfile: backend/services/tenant_orchestrator/Dockerfile
    container_name: milkyhoop-dev-tenant_orchestrator-1
    ports:
      - "7017:5017"
    networks:
      - internal
    environment:
      - GRPC_PORT=5017
      - SERVICE_NAME=TenantOrchestrator
      - DATABASE_URL=${DATABASE_URL}
      - BUSINESS_PARSER_GRPC_HOST=business_parser
      - BUSINESS_PARSER_GRPC_PORT=5018
      - RULE_ENGINE_GRPC_HOST=rule_engine
      - RULE_ENGINE_GRPC_PORT=5070
      - TRANSACTION_GRPC_HOST=transaction_service
      - TRANSACTION_GRPC_PORT=7020
      - REPORTING_GRPC_HOST=reporting_service
      - REPORTING_GRPC_PORT=7030
      - INVENTORY_GRPC_HOST=inventory_service
      - INVENTORY_GRPC_PORT=7040
      - ACCOUNTING_GRPC_HOST=accounting_service
      - ACCOUNTING_GRPC_PORT=7050
    env_file:
      - .env
    volumes:
      - ./backend/services/tenant_orchestrator:/app/backend/services/tenant_orchestrator
      - ./database/schemas:/app/database/schemas
      - ./protos:/app/protos
      - ./logs/tenant_orchestrator:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5017"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
      - redis
      - business_parser
      - rule_engine
      - transaction_service
      - reporting_service
      - inventory_service
      - accounting_service
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


  business_parser:
    build:
      context: .
      dockerfile: backend/services/business_parser/Dockerfile
    container_name: milkyhoop-dev-business_parser-1
    ports:
      - "7018:5018"
    networks:
      - internal
    environment:
      - GRPC_PORT=5018
      - SERVICE_NAME=BusinessParser
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    env_file:
      - .env
    volumes:
      - ./backend/services/business_parser:/app/backend/services/business_parser
      - ./protos:/app/protos
      - ./logs/business_parser:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5018"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  rule_engine:
    build:
      context: .
      dockerfile: backend/services/rule_engine/Dockerfile
    container_name: milkyhoop-dev-rule_engine-1
    ports:
      - "7070:5070"
    networks:
      - internal
    environment:
      - GRPC_PORT=5070
      - SERVICE_NAME=RuleEngine
      - DATABASE_URL=${DATABASE_URL}
      - CACHE_TTL_SECONDS=300
      - LOG_LEVEL=INFO
    env_file:
      - .env
    volumes:
      - ./backend/services/rule_engine:/app/backend/services/rule_engine
      - ./database/schemas:/app/database/schemas
      - ./protos:/app/protos
      - ./logs/rule_engine:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5070"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: always
    depends_on:
      - postgres
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  outbox_worker:
    build:
      context: .
      dockerfile: backend/services/outbox_worker/Dockerfile
    container_name: milkyhoop-dev-outbox_worker-1
    ports:
      - "7060:5060"
    networks:
      - internal
    environment:
      - GRPC_PORT=5060
      - SERVICE_NAME=OutboxWorker
      - DATABASE_URL=${DATABASE_URL}
      - POLL_INTERVAL=2
    env_file:
      - .env
    volumes:
      - ./backend/services/outbox_worker:/app/backend/services/outbox_worker
      - ./protos:/app/protos
      - ./logs/outbox_worker:/var/log
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=localhost:5060"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: "no"
    depends_on:
      - postgres
      - inventory_service
      - accounting_service
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"



  frontend:
    build:
      context: ./frontend
    container_name: milkyhoop-dev-frontend-1
    ports:
      - "3001:80"
    depends_on:
      - api_gateway
    networks:
      - internal
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_data:
  redis_data:

networks:
  internal:
    external: true
    name: milkyhoop_dev_network
