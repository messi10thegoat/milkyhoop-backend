name: milkyhoop-dev
services:
  api_gateway:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/api_gateway/Dockerfile
    depends_on:
      chatbot_service:
        condition: service_started
        required: true
      postgres:
        condition: service_started
        required: true
      ragcrud_service:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_DISABLED_PATHS: /auth/login,/health,/healthz
      AUTH_SERVICE_PORT: "7004"
      CHATBOT_GRPC_HOST: chatbot_service
      CHATBOT_SERVICE_PORT: "7003"
      CONTEXT_SERVICE_PORT: "7007"
      CONVERSATION_SERVICE_PORT: "7002"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      ENVIRONMENT: development
      FLOW_EXECUTOR_HOST: http://flow-executor:8088
      INTENT_PARSER_GRPC_HOST: intent_parser
      INTENT_PARSER_PORT: "7009"
      JWT_SECRET: bb599073be39674d540ba07d77967282d4fa26247f6d17d8a60b093002d70d40
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "7008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: postgres
      RAG_GRPC_HOST: ragcrud_service
      RAGCRUD_GRPC_HOST: ragcrud_service
      RAGCRUD_SERVICE_PORT: "7001"
      RAGINDEX_SERVICE_PORT: "7006"
      RAGLLM_GRPC_HOST: ragllm_service
      RAGLLM_SERVICE_PORT: "7011"
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      TENANT_PARSER_PORT: "7012"
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8000/healthz
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 8000
        published: "8001"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/api_gateway
        target: /var/log
        bind:
          create_host_path: true
  auth_service:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/auth_service/Dockerfile
    depends_on:
      postgres:
        condition: service_started
        required: true
      redis:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5004"
      HTTP_PORT: "8000"
      INTENT_PARSER_PORT: "6006"
      JWT_SECRET: bb599073be39674d540ba07d77967282d4fa26247f6d17d8a60b093002d70d40
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      REDIS_URL: redis://redis:6379
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5004
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5004
        published: "7004"
        protocol: tcp
      - mode: ingress
        target: 8000
        published: "19000"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/auth_service
        target: /var/log
        bind:
          create_host_path: true
  chatbot_service:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/chatbot_service/Dockerfile
    depends_on:
      postgres:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_DISABLED_PATHS: /auth/login,/health,/healthz
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      ENVIRONMENT: development
      GRPC_PORT: "5002"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5002
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5002
        published: "7003"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/chatbot_service
        target: /var/log
        bind:
          create_host_path: true
  context_service:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/context_service/Dockerfile
    depends_on:
      postgres:
        condition: service_started
        required: true
      redis:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5007"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      REDIS_URL: redis://redis:6379
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5007
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5007
        published: "7007"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/context_service
        target: /var/log
        bind:
          create_host_path: true
  conversation_service:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/conversation_service/Dockerfile
    depends_on:
      postgres:
        condition: service_started
        required: true
      redis:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5002"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      REDIS_URL: redis://redis:6379
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5002
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5002
        published: "7002"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/conversation_service
        target: /var/log
        bind:
          create_host_path: true
  cust_context:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/cust_context/Dockerfile
    depends_on:
      postgres:
        condition: service_started
        required: true
      redis:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5008"
      HTTP_PORT: "8080"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION: python
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      REDIS_URL: redis://redis:6379
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5008
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 8080
        published: "8080"
        protocol: tcp
      - mode: ingress
        target: 5008
        published: "7008"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/cust_context
        target: /var/log
        bind:
          create_host_path: true
  cust_reference:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/cust_reference/Dockerfile
    depends_on:
      cust_context:
        condition: service_started
        required: true
      postgres:
        condition: service_started
        required: true
      redis:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_HOST: cust_context
      CONTEXT_SERVICE_PORT: "5008"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5013"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      REDIS_URL: redis://redis:6379
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5013
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 8080
        published: "8080"
        protocol: tcp
      - mode: ingress
        target: 5013
        published: "7013"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/cust_reference
        target: /var/log
        bind:
          create_host_path: true
  flow-executor:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/flow-executor/Dockerfile
    depends_on:
      kafka:
        condition: service_started
        required: true
      postgres:
        condition: service_started
        required: true
      ragcrud_service:
        condition: service_started
        required: true
      ragllm_service:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      HTTP_PORT: "8088"
      INTENT_PARSER_PORT: "6006"
      KAFKA_BROKER: kafka:9092
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_GRPC_HOST: ragcrud_service
      RAGCRUD_GRPC_PORT: "5001"
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_GRPC_HOST: ragllm_service
      RAGLLM_GRPC_PORT: "5000"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8088/health
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 8088
        published: "8088"
        protocol: tcp
      - mode: ingress
        target: 8088
        published: "7088"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/flow-executor
        target: /var/log
        bind:
          create_host_path: true
      - type: bind
        source: /root/milkyhoop-dev/flows
        target: /flows
        bind:
          create_host_path: true
  frontend:
    build:
      context: /root/milkyhoop-dev/frontend/web
      dockerfile: Dockerfile
    container_name: milkyhoop-frontend-1
    depends_on:
      api_gateway:
        condition: service_started
        required: true
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 80
        published: "3000"
        protocol: tcp
    restart: always
  intent_parser:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/intent_parser/Dockerfile
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5009"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5009
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5009
        published: "7009"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/intent_parser
        target: /var/log
        bind:
          create_host_path: true
  kafka:
    depends_on:
      zookeeper:
        condition: service_started
        required: true
    environment:
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_BROKER_ID: "1"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    healthcheck:
      test:
        - CMD
        - kafka-topics
        - --list
        - --bootstrap-server
        - localhost:9092
      timeout: 10s
      interval: 30s
      retries: 5
    image: confluentinc/cp-kafka:7.3.2
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 9092
        published: "9092"
        protocol: tcp
    restart: always
  memory_service:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/memory_service/Dockerfile
    depends_on:
      postgres:
        condition: service_started
        required: true
      redis:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5000"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      REDIS_URL: redis://redis:6379
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5000
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5000
        published: "5000"
        protocol: tcp
      - mode: ingress
        target: 5000
        published: "7000"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/memory_service
        target: /var/log
        bind:
          create_host_path: true
  notification_service:
    build:
      context: /root/milkyhoop-dev/backend/services/notification-service
      dockerfile: Dockerfile
    depends_on:
      kafka:
        condition: service_started
        required: true
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_GROUP_ID: notification-service
      KAFKA_TOPIC: send-notification
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5005
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5005
        published: "7005"
        protocol: tcp
      - mode: ingress
        target: 8080
        published: "5080"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/notification_service
        target: /var/log
        bind:
          create_host_path: true
  postgres:
    environment:
      POSTGRES_DB: milkydb
      POSTGRES_PASSWORD: password
      POSTGRES_USER: milkyadmin
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U milkyadmin
      timeout: 5s
      interval: 10s
      retries: 5
    image: postgres:14
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5432
        published: "5433"
        protocol: tcp
    restart: always
    volumes:
      - type: volume
        source: postgres_data
        target: /var/lib/postgresql/data
        volume: {}
      - type: bind
        source: /root/milkyhoop-dev/logs/postgres
        target: /var/log/postgresql
        bind:
          create_host_path: true
  ragcrud_service:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/ragcrud_service/Dockerfile
    depends_on:
      postgres:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5001"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      PRISMA_QUERY_ENGINE_BINARY: /app/prisma-query-engine-debian-openssl-3.0.x
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5001
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5001
        published: "7001"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/ragcrud_service
        target: /var/log
        bind:
          create_host_path: true
  ragindex_service:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/ragindex_service/Dockerfile
    depends_on:
      postgres:
        condition: service_started
        required: true
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5006"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5006
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5006
        published: "7006"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/ragindex_service
        target: /var/log
        bind:
          create_host_path: true
  ragllm_service:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/ragllm_service/Dockerfile
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5000"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5000
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5000
        published: "7011"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/ragllm_service
        target: /var/log
        bind:
          create_host_path: true
  redis:
    command:
      - redis-server
      - --requirepass
      - MilkyRedis2025Secure
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      timeout: 5s
      interval: 10s
      retries: 5
    image: redis:latest
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 6379
        published: "6380"
        protocol: tcp
    restart: always
    volumes:
      - type: volume
        source: redis_data
        target: /data
        volume: {}
      - type: bind
        source: /root/milkyhoop-dev/logs/redis
        target: /var/log/redis
        bind:
          create_host_path: true
  tenant_parser:
    build:
      context: /root/milkyhoop-dev
      dockerfile: backend/services/tenant_parser/Dockerfile
    environment:
      API_GATEWAY_PORT: "9000"
      AUTH_SERVICE_PORT: "6001"
      CHATBOT_SERVICE_PORT: "6002"
      CONTEXT_SERVICE_PORT: "6010"
      CONVERSATION_SERVICE_PORT: "6009"
      CUST_CONTEXT_PORT: "6011"
      DATABASE_URL: postgresql://milkyadmin:password@postgres:5432/milkydb
      DEBUG: "true"
      DEV_POSTGRES_PORT: "5433"
      DEV_REDIS_PORT: "6380"
      GRPC_PORT: "5012"
      INTENT_PARSER_PORT: "6006"
      LOG_LEVEL: debug
      MEMORY_SERVICE_PORT: "6008"
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      POSTGRES_DB: milkyhoop_dev
      POSTGRES_HOST: localhost
      POSTGRES_PASSWORD: postgres
      POSTGRES_PORT: "6432"
      POSTGRES_USER: postgres
      RAGCRUD_SERVICE_PORT: "6003"
      RAGINDEX_SERVICE_PORT: "6005"
      RAGLLM_SERVICE_PORT: "6004"
      REDIS_HOST: localhost
      REDIS_PORT: "7379"
      TENANT_PARSER_PORT: "6007"
    healthcheck:
      test:
        - CMD
        - grpc_health_probe
        - -addr=localhost:5012
      timeout: 3s
      interval: 30s
      retries: 3
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 5012
        published: "7012"
        protocol: tcp
    restart: always
    volumes:
      - type: bind
        source: /root/milkyhoop-dev/logs/tenant_parser
        target: /var/log
        bind:
          create_host_path: true
  zookeeper:
    environment:
      ZOOKEEPER_CLIENT_PORT: "2181"
      ZOOKEEPER_TICK_TIME: "2000"
    image: confluentinc/cp-zookeeper:7.3.2
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      internal: null
    ports:
      - mode: ingress
        target: 2181
        published: "2181"
        protocol: tcp
    restart: always
networks:
  internal:
    name: milkyhoop_dev_network
    driver: bridge
    external: true
volumes:
  postgres_data:
    name: milkyhoop-dev_postgres_data
  redis_data:
    name: milkyhoop-dev_redis_data
